generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  name         String
  email        String    @unique
  password     String
  phone        String    @default("")
  role         String    @default("user")
  authProvider String    @default("local")
  googleId     String?   @unique
  avatarUrl    String    @default("")
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
  bookings     Booking[]
  payments     Payment[]
  adminAudits  AdminAudit[] @relation("AdminAuditActor")

  @@index([role])
}

model Booking {
  id        Int       @id @default(autoincrement())
  userId    Int?
  name      String
  email     String
  phone     String
  service   String    @default("consultation")
  message   String    @default("")
  status    String    @default("pending")
  createdAt DateTime  @default(now())
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([email])
}

model Payment {
  id          String   @id
  userId      Int
  productId   String?
  productName String?
  amount      Float
  currency    String   @default("KGS")
  status      String   @default("completed")
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AdminAudit {
  id          Int      @id @default(autoincrement())
  adminUserId Int?
  action      String
  targetType  String
  targetId    String?
  details     Json?
  createdAt   DateTime @default(now())
  adminUser   User?    @relation("AdminAuditActor", fields: [adminUserId], references: [id], onDelete: SetNull)

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
}

model Content {
  id        Int      @id @default(autoincrement())
  type      String
  data      Json
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

model ChatSession {
  id          Int           @id @default(autoincrement())
  sessionId   String        @unique
  locale      String?
  leadName    String?
  leadEmail   String?
  leadPhone   String?
  leadService String?
  leadMessage String?
  leadStatus  String        @default("open")
  bookingId   Int?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  messages    ChatMessage[]

  @@index([updatedAt])
  @@index([leadStatus])
  @@index([leadEmail])
  @@index([leadPhone])
}

model ChatMessage {
  id            Int         @id @default(autoincrement())
  chatSessionId Int
  role          String
  content       String
  createdAt     DateTime    @default(now())
  chatSession   ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)

  @@index([chatSessionId, createdAt])
}
